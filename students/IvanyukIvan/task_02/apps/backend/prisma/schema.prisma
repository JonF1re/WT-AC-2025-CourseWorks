generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  admin
  user
}

model User {
  id             String         @id @default(uuid())
  username       String         @unique
  email          String         @unique
  passwordHash   String
  role           Role           @default(user)
  createdAt      DateTime       @default(now())

  goals          Goal[]
  refreshTokens  RefreshToken[]
}

model Topic {
  id          String   @id @default(uuid())
  name        String
  description String?
  createdAt   DateTime @default(now())

  goals       Goal[]
}

model Goal {
  id          String    @id @default(uuid())
  topicId     String
  userId      String
  name        String
  description String?
  targetValue Int
  deadline    DateTime?
  createdAt   DateTime  @default(now())

  topic           Topic          @relation(fields: [topicId], references: [id], onDelete: Cascade)
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  progressEntries ProgressEntry[]

  @@index([userId])
  @@index([topicId])
}

model ProgressEntry {
  id        String   @id @default(uuid())
  goalId    String
  timestamp DateTime @default(now())
  value     Int
  comment   String?

  goal Goal @relation(fields: [goalId], references: [id], onDelete: Cascade)

  @@index([goalId])
  @@index([timestamp])
}

model RefreshToken {
  id                String    @id @default(uuid())
  tokenHash         String    @unique
  userId            String
  expiresAt         DateTime
  revokedAt         DateTime?
  replacedByTokenId String?
  createdByIp       String?
  userAgent         String?
  createdAt         DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}
