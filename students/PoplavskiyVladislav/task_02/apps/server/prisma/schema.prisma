generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  admin
  user
}

enum MembershipRole {
  owner
  member
}

enum MaterialType {
  link
  file
  note
}

enum TaskStatus {
  todo
  in_progress
  done
}

model User {
  id           String      @id @default(uuid())
  username     String      @unique
  email        String      @unique
  passwordHash String      @map("password_hash")
  role         UserRole    @default(user)
  createdAt    DateTime    @default(now()) @map("created_at")

  ownedGroups  StudyGroup[]
  memberships  Membership[]
  materials    Material[]   @relation("MaterialCreatedBy")
  createdTasks Task[]       @relation("TaskCreatedBy")
  assignedTask Task[]       @relation("TaskAssignee")

  @@map("users")
}

model StudyGroup {
  id          String       @id @default(uuid())
  title       String
  description String?
  isPublic    Boolean      @default(true) @map("is_public")
  createdAt   DateTime     @default(now()) @map("created_at")

  ownerId     String       @map("owner_id")
  owner       User         @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  memberships Membership[]
  topics      Topic[]
  meetings    Meeting[]
  materials   Material[]
  tasks       Task[]

  @@map("study_groups")
}

model Membership {
  id       String          @id @default(uuid())
  role     MembershipRole  @default(member)
  joinedAt DateTime        @default(now()) @map("joined_at")

  groupId  String          @map("group_id")
  group    StudyGroup      @relation(fields: [groupId], references: [id], onDelete: Cascade)

  userId   String          @map("user_id")
  user     User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
  @@map("memberships")
}

model Topic {
  id          String     @id @default(uuid())
  title       String
  description String?
  order       Int?

  isDone      Boolean    @default(false) @map("is_done")
  doneAt      DateTime?  @map("done_at")

  groupId     String     @map("group_id")
  group       StudyGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  meetings    Meeting[]
  materials   Material[]
  tasks       Task[]

  @@index([groupId])
  @@map("topics")
}

model Meeting {
  id              String     @id @default(uuid())
  startsAt        DateTime   @map("starts_at")
  durationMinutes Int        @map("duration_minutes")
  place           String?
  link            String?
  notes           String?

  groupId         String     @map("group_id")
  group           StudyGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  topicId         String?    @map("topic_id")
  topic           Topic?     @relation(fields: [topicId], references: [id], onDelete: SetNull)

  @@index([groupId])
  @@index([topicId])
  @@map("meetings")
}

model Material {
  id        String       @id @default(uuid())
  title     String
  type      MaterialType
  url       String?
  content   String?
  createdAt DateTime     @default(now()) @map("created_at")

  groupId   String       @map("group_id")
  group     StudyGroup   @relation(fields: [groupId], references: [id], onDelete: Cascade)

  topicId   String?      @map("topic_id")
  topic     Topic?       @relation(fields: [topicId], references: [id], onDelete: SetNull)

  createdById String     @map("created_by")
  createdBy   User       @relation("MaterialCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)

  @@index([groupId])
  @@index([topicId])
  @@map("materials")
}

model Task {
  id          String      @id @default(uuid())
  title       String
  description String?
  dueAt       DateTime?   @map("due_at")
  status      TaskStatus  @default(todo)
  createdAt   DateTime    @default(now()) @map("created_at")

  groupId     String      @map("group_id")
  group       StudyGroup  @relation(fields: [groupId], references: [id], onDelete: Cascade)

  topicId     String?     @map("topic_id")
  topic       Topic?      @relation(fields: [topicId], references: [id], onDelete: SetNull)

  createdById String      @map("created_by")
  createdBy   User        @relation("TaskCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)

  assigneeId  String?     @map("assignee_id")
  assignee    User?       @relation("TaskAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)

  @@index([groupId])
  @@index([topicId])
  @@index([assigneeId])
  @@map("tasks")
}
